<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>R&C GOLD UNIVERSAL V16</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>

    <style>
        /* --- TEMA GOLD V16 --- */
        :root { 
            --bg: #050505; 
            --gold: #FFD700; 
            --text: #ffffff; 
            --panel: #111;
            --focus-bg: linear-gradient(45deg, var(--gold), #B8860B);
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; outline: none; user-select: none; }
        
        body {
            background-color: var(--bg); color: var(--text);
            font-family: 'Montserrat', sans-serif;
            width: 100vw; height: 100vh; overflow: hidden;
        }

        .hide { display: none !important; }
        .flex-center { display: flex; align-items: center; justify-content: center; }
        .layer { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 10; background: #000; }

        /* FOCO */
        .focused {
            border: 3px solid #fff !important;
            background: var(--focus-bg) !important;
            color: #000 !important;
            transform: scale(1.03);
            font-weight: 800;
            box-shadow: 0 0 35px rgba(255, 215, 0, 0.5);
            z-index: 20;
        }
        .focused i { color: #000 !important; }
        .focused .epg-hint { color: #000 !important; }
        .playing-item { color: var(--gold) !important; border-left: 3px solid var(--gold); background: #151515; }

        /* LOGIN */
        #login-layer { background: radial-gradient(circle at center, #1a1a1a 0%, #000 100%); }
        .login-box { width: 450px; padding: 40px; background: #111; border: 1px solid #333; border-radius: 12px; text-align: center; }
        .logo-txt { font-size: 32px; font-weight: 900; letter-spacing: -1px; margin-bottom: 20px; }
        .logo-txt span { color: var(--gold); }
        .inp { width: 100%; padding: 14px; margin: 10px 0; background: #222; border: 1px solid #444; color: #fff; text-align: center; font-weight: bold; border-radius: 6px; font-size: 16px; }
        .btn { width: 100%; padding: 14px; margin-top: 20px; background: var(--gold); color: #000; border: none; cursor: pointer; text-transform: uppercase; font-weight: 900; border-radius: 6px; }

        /* DASHBOARD */
        #dash-layer { flex-direction: column; background: #080808; justify-content: space-between; }
        .dash-header { margin-top: 60px; text-align: center; }
        .dash-grid { display: flex; gap: 40px; margin-bottom: auto; margin-top: 40px; justify-content: center; }
        .card { width: 220px; height: 200px; background: #151515; border: 2px solid #333; border-radius: 15px; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: 0.2s; }
        .card i { font-size: 60px; margin-bottom: 20px; color: #555; }
        .card span { font-size: 14px; font-weight: 700; color: #888; text-transform: uppercase; }

        .dash-info { width: 90%; display: flex; justify-content: space-between; align-items: center; background: #111; border: 1px solid #333; border-radius: 8px; padding: 20px 40px; margin-bottom: 40px; align-self: center; }
        .info-item { text-align: center; }
        .info-label { font-size: 11px; color: #666; font-weight: bold; margin-bottom: 5px; letter-spacing: 1px; }
        .info-val { font-size: 16px; color: var(--gold); font-weight: 800; }

        /* CONTE√öDO */
        #content-layer { display: flex; }
        .col-cat { width: 25%; background: #080808; border-right: 1px solid #222; display: flex; flex-direction: column; }
        .cat-head { padding: 15px; background: var(--gold); color: #000; font-weight: 900; text-align: center; }
        .cat-list { flex: 1; overflow-y: auto; }
        .cat-item { padding: 14px 20px; border-bottom: 1px solid #1a1a1a; color: #888; font-size: 13px; font-weight: 600; white-space: nowrap; overflow: hidden; display: flex; justify-content: space-between;}
        .cat-item.active { border-left: 5px solid var(--gold); background: #1a1a1a; color: #fff; }

        .col-list { width: 35%; background: #0e0e0e; border-right: 1px solid #222; display: flex; flex-direction: column; }
        .search-area { padding: 10px; background: #000; border-bottom: 1px solid #333; display: flex; gap: 10px; position: relative; align-items: center; }
        .search-icon-btn { position: absolute; left: 20px; z-index: 5; color: #666; cursor: pointer; font-size: 18px; padding: 5px; }
        .inp-search { width: 100%; background: #222; border: 1px solid #333; color: #fff; padding: 10px 10px 10px 40px; text-align: left; font-weight: bold; border-radius: 4px; text-transform: uppercase; }
        .item-list { flex: 1; overflow-y: auto; }
        .item { padding: 14px 20px; border-bottom: 1px solid #1a1a1a; color: #bbb; white-space: nowrap; overflow: hidden; font-size: 14px; position: relative; }
        .fav-icon { float: right; color: var(--gold); margin-left: 10px; font-size: 12px; }
        
        /* PLAYER */
        .col-play { flex: 1; background: #000; display: flex; flex-direction: column; position: relative; }
        .vid-box { width: 100%; height: 50%; background: #000; position: relative; border-bottom: 2px solid #333; transform: translateZ(0); }
        /* Fullscreen real */
        .vid-box.fs { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; z-index: 9999; border: none !important; outline: none !important; }
        video { width: 100%; height: 100%; object-fit: contain; background: #000; outline: none; }

        /* OSD & INFO */
        .osd-status { position: absolute; top: 20px; right: 20px; background: rgba(0,0,0,0.8); color: var(--gold); padding: 10px 20px; border-radius: 5px; font-weight: 800; display: none; border: 1px solid var(--gold); z-index: 10000; }
        
        .meta { padding: 30px; flex: 1; background: #050505; display: flex; flex-direction: column; overflow: hidden; }
        .meta-title { font-size: 22px; color: var(--gold); font-weight: 800; margin-bottom: 5px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .meta-epg { font-size: 13px; color: #fff; margin-bottom: 10px; background: #222; padding: 5px 10px; border-radius: 4px; display: inline-block; width: fit-content; }
        .meta-desc { font-size: 14px; color: #666; margin-bottom: auto; overflow-y: auto; max-height: 100px; }
        
        /* Barra de progresso customizada (VOD) */
        .progress-container { width: 100%; height: 6px; background: #333; margin-top: 10px; border-radius: 3px; position: relative; display: none; }
        .progress-bar { height: 100%; background: var(--gold); width: 0%; border-radius: 3px; }
        
        .keys { display: flex; gap: 20px; margin-top: 15px; padding: 15px; background: #111; border-radius: 8px; border: 1px solid #222; }
        .key { display: flex; align-items: center; gap: 8px; font-size: 11px; font-weight: bold; color: #aaa; }
        .dot { width: 12px; height: 12px; border-radius: 50%; }

        #loader { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.95); z-index:20000; display:flex; flex-direction:column; align-items:center; justify-content:center; color:var(--gold); font-weight:900; font-size:24px; }
    </style>
</head>
<body onload="App.init()">

    <div id="loader" class="hide">
        <i class="fas fa-circle-notch fa-spin" style="font-size:50px; margin-bottom:20px"></i>
        <div id="load-txt">CARREGANDO...</div>
    </div>

    <div id="login-layer" class="layer flex-center">
        <div class="login-box">
            <div class="logo-txt">R&C <span>GOLD</span></div>
            <input type="text" id="i0" class="inp focusable" placeholder="http://url_dns" autocomplete="off">
            <input type="text" id="i1" class="inp focusable" placeholder="USU√ÅRIO" autocomplete="off">
            <input type="password" id="i2" class="inp focusable" placeholder="SENHA" autocomplete="off">
            <button id="i3" class="btn focusable" onclick="App.login()">CONECTAR</button>
            <div id="msg-login" style="color:red; margin-top:15px; font-size:12px; font-weight:bold;"></div>
        </div>
    </div>

    <div id="dash-layer" class="layer hide flex-center">
        <div class="dash-header">
            <div class="logo-txt" style="font-size:60px;">R&C <span>GOLD</span></div>
        </div>
        <div class="dash-grid">
            <div id="m0" class="card focusable" onclick="App.openMode('live')"><i class="fas fa-tv"></i><span>TV AO VIVO</span></div>
            <div id="m1" class="card focusable" onclick="App.openMode('movie')"><i class="fas fa-film"></i><span>FILMES</span></div>
            <div id="m2" class="card focusable" onclick="App.openMode('series')"><i class="fas fa-video"></i><span>S√âRIES</span></div>
            <div id="m3" class="card focusable" onclick="App.logout()"><i class="fas fa-sign-out-alt"></i><span>SAIR</span></div>
        </div>
        <div class="dash-info">
            <div class="info-item"><div class="info-label">CRIADO EM</div><div class="info-val" id="info-created">...</div></div>
            <div class="info-item"><div class="info-label">CONEX√ïES</div><div class="info-val" id="info-conn">...</div></div>
            <div class="info-item"><div class="info-label">VENCIMENTO</div><div class="info-val" id="info-exp">...</div></div>
        </div>
    </div>

    <div id="content-layer" class="layer hide">
        <div class="col-cat">
            <div class="cat-head">CATEGORIAS</div>
            <div id="cat-list" class="cat-list"></div>
        </div>
        <div class="col-list">
            <div class="search-area">
                <i class="fas fa-search search-icon-btn" onclick="App.doSearch()"></i>
                <input type="text" id="search" class="inp-search focusable" placeholder="PESQUISAR..." autocomplete="off">
            </div>
            <div id="item-list" class="item-list"></div>
        </div>
        <div class="col-play">
            <div id="vid-box" class="vid-box">
                <video id="player"></video>
                <div id="osd" class="osd-status">PLAY</div>
            </div>
            <div class="meta">
                <div id="meta-title" class="meta-title">R&C GOLD</div>
                <div id="meta-epg" class="meta-epg hide">EPG...</div>
                <div class="progress-container" id="vod-prog"><div class="progress-bar" id="vod-bar"></div></div>
                <div id="meta-desc" class="meta-desc">Selecione um conte√∫do.</div>
                
                <div class="keys">
                    <div class="key"><div class="dot" style="background:#ff4444"></div> TELA CHEIA</div>
                    <div class="key"><div class="dot" style="background:#00C851"></div> TOPO</div>
                    <div class="key"><div class="dot" style="background:#ffbb33"></div> BUSCAR</div>
                    <div class="key"><div class="dot" style="background:#33b5e5"></div> MENU</div>
                    <div class="key" style="margin-left:auto; color:#fff">TECLA 0: FAVORITAR</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- GERENCIADOR DE FAVORITOS ---
        var FavManager = {
            key: 'rc_favs',
            list: [],
            init: function() {
                var s = localStorage.getItem(this.key);
                this.list = s ? JSON.parse(s) : [];
            },
            toggle: function(id) {
                var idx = this.list.indexOf(id);
                if(idx > -1) this.list.splice(idx, 1);
                else this.list.push(id);
                localStorage.setItem(this.key, JSON.stringify(this.list));
                // Atualiza visualmente se estiver na lista
                App.renderList(App.fullData); 
            },
            isFav: function(id) { return this.list.indexOf(id) > -1; }
        };

        var PlayerEngine = {
            hls: null, video: null, url: null, retryCount: 0, monitorInterval: null, lastTime: 0,
            
            init: function() { this.video = document.getElementById('player'); },

            play: function(url, isLive) {
                // N√£o para o player se a URL for a mesma (evita tela preta ao navegar)
                if(this.url === url && !this.video.paused) return;

                this.stop(); 
                this.retryCount = 0;
                this.url = url;

                // VOD CONFIG
                if (!isLive) {
                    this.video.controls = true; 
                    this.video.src = url;
                    this.video.play().catch(e=>console.log(e));
                    // Monitoramento de progresso VOD
                    this.video.ontimeupdate = function() {
                        if(App.zone===3 || App.mode!=='live') {
                            var p = (this.currentTime / this.duration) * 100;
                            document.getElementById('vod-bar').style.width = p + '%';
                        }
                    };
                    return; 
                }

                // LIVE CONFIG
                this.video.controls = false;
                this.video.ontimeupdate = null;
                var isPC = Hls.isSupported() && !/(SMART-TV|SmartTV|NetCast|Tizen|Web0S)/.test(navigator.userAgent);
                if(isLive && isPC && url.indexOf('.m3u8') === -1) url = url.replace('.ts', '.m3u8');

                if (Hls.isSupported() && (isLive || url.includes('.m3u8'))) {
                    // Configura√ß√£o OTIMIZADA para estabilidade
                    var config = { 
                        maxBufferLength: 10, // Menor buffer inicial
                        maxMaxBufferLength: 20,
                        enableWorker: true, 
                        lowLatencyMode: true,
                        backBufferLength: 10,
                        manifestLoadingTimeOut: 20000,
                        manifestLoadingMaxRetry: 5
                    };
                    this.hls = new Hls(config);
                    this.hls.loadSource(url);
                    this.hls.attachMedia(this.video);
                    this.hls.on(Hls.Events.MANIFEST_PARSED, () => { this.video.play().catch(e=>console.log(e)); });
                    
                    // Tratamento agressivo de erros
                    this.hls.on(Hls.Events.ERROR, (event, data) => {
                        if (data.fatal) {
                            switch (data.type) {
                                case Hls.ErrorTypes.NETWORK_ERROR:
                                    console.log('HLS: Erro de Rede, tentando recuperar...');
                                    this.hls.startLoad();
                                    break;
                                case Hls.ErrorTypes.MEDIA_ERROR:
                                    console.log('HLS: Erro de M√≠dia, tentando recuperar...');
                                    this.hls.recoverMediaError();
                                    break;
                                default:
                                    this.stop();
                                    break;
                            }
                        }
                    });
                    this.startMonitor(isLive);
                } else {
                    // Fallback nativo
                    this.video.src = url;
                    this.video.play().catch(e=>console.log(e));
                }
            },

            stop: function() {
                if(this.hls) { this.hls.destroy(); this.hls = null; }
                if(this.video) { 
                    this.video.pause(); 
                    this.video.src = ""; 
                    this.video.load(); 
                    this.video.controls = false; 
                }
                clearInterval(this.monitorInterval);
            },

            startMonitor: function(isLive) {
                if(!isLive) return;
                clearInterval(this.monitorInterval);
                this.lastTime = 0;
                this.monitorInterval = setInterval(() => {
                    var v = this.video;
                    if(!v.paused && v.readyState > 2) {
                        if(v.currentTime === this.lastTime) {
                            this.retryCount++;
                            // Se travar por 5 segundos, tenta reiniciar o stream silenciosamente
                            if(this.retryCount > 2) {
                                App.osd("RECARREGANDO...");
                                if(this.hls) this.hls.recoverMediaError(); else v.load();
                                this.retryCount = 0;
                            }
                        } else {
                            this.retryCount = 0;
                        }
                        this.lastTime = v.currentTime;
                    }
                }, 2000); // Check a cada 2 segundos
            }
        };

        var App = {
            scr: 0, zone: 0, idx: 0, lastCatIdx: 0, // lastCatIdx para lembrar categoria
            creds: {h:'', u:'', p:''},
            mode: '', fullData: [], globalData: null, seriesEps: [], isFolder: false, memIdx: 0, currentPlayingUrl: '',
            
            init: function() {
                FavManager.init();
                if(localStorage.getItem('rc_h')) {
                    document.getElementById('i0').value = localStorage.getItem('rc_h');
                    document.getElementById('i1').value = localStorage.getItem('rc_u');
                    document.getElementById('i2').value = localStorage.getItem('rc_p');
                }
                this.updateFocus();
                PlayerEngine.init();
                
                // Auto-play next episode
                var v = document.getElementById('player');
                v.onended = function() { 
                    if(App.mode === 'series' && App.isFolder) {
                        var nextIdx = App.idx + 1;
                        if(nextIdx < App.seriesEps.length) {
                            App.idx = nextIdx;
                            App.updateFocus();
                            App.playStream(App.seriesEps[App.idx]);
                            return;
                        }
                    }
                    App.exitFull(); 
                };
            },

            req: function(url, cb) {
                var x = new XMLHttpRequest();
                x.open("GET", url, true);
                x.timeout = 40000;
                x.onload = function() {
                    if(x.status===200) { try{ cb(JSON.parse(x.responseText)); }catch(e){cb(null);} }
                    else cb(null);
                };
                x.onerror = function(){ cb(null); };
                x.send();
            },

            login: function() {
                var h = document.getElementById('i0').value.trim();
                var u = document.getElementById('i1').value.trim();
                var p = document.getElementById('i2').value.trim();
                if(h.endsWith('/')) h=h.slice(0,-1);
                if(h.indexOf('http')===-1) h='http://'+h;
                document.getElementById('loader').classList.remove('hide');
                document.getElementById('load-txt').innerText = "CONECTANDO...";
                this.req(h+"/player_api.php?username="+u+"&password="+p, function(d){
                    document.getElementById('loader').classList.add('hide');
                    if(d && d.user_info && d.user_info.auth==1) {
                        App.creds={h:h,u:u,p:p};
                        localStorage.setItem('rc_h', h); localStorage.setItem('rc_u', u); localStorage.setItem('rc_p', p);
                        
                        var info = d.user_info;
                        var dateCreated = new Date(info.created_at * 1000).toLocaleDateString("pt-BR");
                        var dateExp = info.exp_date ? new Date(info.exp_date * 1000).toLocaleDateString("pt-BR") : "Ilimitado";
                        document.getElementById('info-created').innerText = dateCreated;
                        document.getElementById('info-conn').innerText = (info.active_cons||0) + " / " + (info.max_connections||1);
                        document.getElementById('info-exp').innerText = dateExp;

                        App.setScr(1);
                    } else document.getElementById('msg-login').innerText="Login falhou.";
                });
            },
            
            logout: function() { 
                localStorage.clear(); 
                this.creds = {h:'', u:'', p:''};
                document.getElementById('i0').value = "";
                document.getElementById('i1').value = "";
                document.getElementById('i2').value = "";
                this.setScr(0);
            },

            setScr: function(n) {
                if(n===1) PlayerEngine.stop(); // S√≥ para o player se voltar pro dashboard
                document.getElementById('login-layer').classList.add('hide');
                document.getElementById('dash-layer').classList.add('hide');
                document.getElementById('content-layer').classList.add('hide');
                this.scr=n; this.zone=0; this.idx=0;
                if(n===0) document.getElementById('login-layer').classList.remove('hide');
                if(n===1) document.getElementById('dash-layer').classList.remove('hide');
                if(n===2) document.getElementById('content-layer').classList.remove('hide');
                this.updateFocus();
            },

            resetInfo: function() {
                document.getElementById('meta-title').innerText = "R&C GOLD";
                document.getElementById('meta-desc').innerText = "Selecione um conte√∫do.";
                document.getElementById('meta-epg').classList.add('hide');
                document.getElementById('vod-prog').style.display = 'none';
            },

            openMode: function(m) {
                this.mode = m; this.setScr(2); this.resetInfo();
                document.getElementById('cat-list').innerHTML="";
                document.getElementById('item-list').innerHTML="";
                document.getElementById('search').value="";
                this.isFolder = false; this.globalData = null;
                
                var act = (m==='live')?'get_live_categories':(m==='movie'?'get_vod_categories':'get_series_categories');
                
                document.getElementById('loader').classList.remove('hide');
                document.getElementById('load-txt').innerText = "CATEGORIAS...";
                
                this.req(this.creds.h+"/player_api.php?username="+this.creds.u+"&password="+this.creds.p+"&action="+act, function(d){
                    document.getElementById('loader').classList.add('hide');
                    if(d) {
                        App.fullData=[]; 
                        // Adiciona Favoritos no topo
                        var h='<div class="cat-item" id="c0" data-id="fav">‚≠ê FAVORITOS</div>';
                        for(var i=0;i<d.length;i++) h+='<div class="cat-item" id="c'+(i+1)+'" data-id="'+d[i].category_id+'">'+d[i].category_name+'</div>';
                        document.getElementById('cat-list').innerHTML=h;
                        App.zone=0; App.idx=0; App.updateFocus();
                    }
                });
            },

            loadContent: function(catIdx) {
                this.resetInfo();
                this.lastCatIdx = catIdx; // Salva o √≠ndice da categoria atual
                
                var el = document.getElementById('c'+catIdx);
                if(!el) return;
                var cid = el.getAttribute('data-id');
                
                var all=document.querySelectorAll('.cat-item');
                for(var i=0;i<all.length;i++) all[i].classList.remove('active');
                el.classList.add('active');

                document.getElementById('loader').classList.remove('hide');
                document.getElementById('load-txt').innerText = "CARREGANDO...";
                document.getElementById('item-list').innerHTML="";

                // L√≥gica especial Favoritos
                if(cid === 'fav') {
                    // Carrega tudo primeiro pra filtrar (pode ser otimizado, mas funciona universalmente)
                    var act = (this.mode==='live')?'get_live_streams':(this.mode==='movie'?'get_vod_streams':'get_series');
                    this.req(this.creds.h+"/player_api.php?username="+this.creds.u+"&password="+this.creds.p+"&action="+act, function(d){
                        document.getElementById('loader').classList.add('hide');
                        if(d) {
                            var favs = d.filter(function(x){ return FavManager.isFav(x.stream_id || x.series_id); });
                            App.fullData = favs; App.isFolder = false; App.renderList(favs);
                            App.zone=2; App.idx=0; App.updateFocus();
                        }
                    });
                    return;
                }

                var act = (this.mode==='live')?'get_live_streams':(this.mode==='movie'?'get_vod_streams':'get_series');
                this.req(this.creds.h+"/player_api.php?username="+this.creds.u+"&password="+this.creds.p+"&action="+act+"&category_id="+cid, function(d){
                    document.getElementById('loader').classList.add('hide');
                    if(d) {
                        App.fullData = d;
                        App.isFolder = false;
                        App.renderList(d);
                        App.zone=2; App.idx=0; App.updateFocus();
                    }
                });
            },

            renderList: function(d) {
                var h=""; var max=d.length>500?500:d.length; // Limite seguran√ßa
                if(max===0) h='<div style="padding:20px">Vazio</div>';
                for(var i=0;i<max;i++) {
                    var n = d[i].name || d[i].title;
                    var id = d[i].stream_id || d[i].series_id;
                    var favIcon = FavManager.isFav(id) ? '<i class="fas fa-star fav-icon"></i>' : '';
                    h+='<div class="item" id="it'+i+'">'+n+favIcon+'</div>';
                }
                document.getElementById('item-list').innerHTML=h;
            },

            doSearch: function() {
                var t = document.getElementById('search').value.toLowerCase();
                if(t.length < 3) return;
                document.getElementById('item-list').innerHTML = '<div style="padding:20px">Buscando...</div>';
                if(this.globalData) { this.filterGlobal(t); } 
                else {
                    var act = (this.mode==='live')?'get_live_streams':(this.mode==='movie'?'get_vod_streams':'get_series');
                    this.req(this.creds.h+"/player_api.php?username="+this.creds.u+"&password="+this.creds.p+"&action="+act, function(d){
                        if(d) { App.globalData = d; App.filterGlobal(t); }
                    });
                }
            },

            filterGlobal: function(term) {
                var res = this.globalData.filter(function(x){
                    var n = (x.name||x.title||"").toLowerCase();
                    return n.indexOf(term) > -1;
                });
                this.fullData = res; this.isFolder = false; this.renderList(res);
                this.zone=2; this.idx=0; this.updateFocus();
            },

            clickItem: function() {
                if(this.isFolder) { this.playStream(this.seriesEps[this.idx]); return; }
                
                var el = document.getElementById('it'+this.idx);
                // Pequena prote√ß√£o contra clique fantasma
                if(!el) return;

                var item = this.fullData[this.idx];
                
                if(this.mode !== 'series') {
                    if(item) this.playStream(item);
                    return;
                }

                if(item) {
                    this.memIdx = this.idx;
                    document.getElementById('loader').classList.remove('hide');
                    document.getElementById('load-txt').innerText = "EPIS√ìDIOS...";
                    this.req(this.creds.h+"/player_api.php?username="+this.creds.u+"&password="+this.creds.p+"&action=get_series_info&series_id="+item.series_id, function(d){
                        document.getElementById('loader').classList.add('hide');
                        if(d && d.episodes) {
                            var eps = [];
                            for(var k in d.episodes) for(var j=0; j<d.episodes[k].length; j++) eps.push(d.episodes[k][j]);
                            App.seriesEps = eps;
                            App.isFolder = true;
                            App.renderList(eps);
                            document.getElementById('meta-title').innerText = "üìÇ " + (item.name || item.title);
                            App.idx=0; App.updateFocus();
                        }
                    });
                }
            },

            playStream: function(item) {
                var ext = (this.mode==='live')?'ts':(item.container_extension||'mp4');
                var type = (this.mode==='live')?'live':(this.mode==='movie'?'movie':'series');
                var id = item.stream_id || item.id;
                var url = this.creds.h+"/"+type+"/"+this.creds.u+"/"+this.creds.p+"/"+id+"."+ext;
                
                // Gerencia EPG e Info
                var itemName = item.name || item.title;
                document.getElementById('meta-title').innerText = itemName;
                document.getElementById('meta-desc').innerText = "Carregando...";
                document.getElementById('meta-epg').classList.add('hide');

                if(this.mode === 'live') {
                    // Busca EPG
                    this.req(this.creds.h+"/player_api.php?username="+this.creds.u+"&password="+this.creds.p+"&action=get_short_epg&stream_id="+id, function(d){
                        if(d && d.epg_listings && d.epg_listings.length > 0) {
                            var e = d.epg_listings[0];
                            var txt = atob(e.title); // Muitas vezes vem em base64 ou texto puro
                            // Se falhar decode base64, usa o texto puro
                            try { if(!/^[A-Za-z0-9+/=]+$/.test(e.title)) throw "Not B64"; } catch(err) { txt = e.title; }
                            
                            document.getElementById('meta-epg').innerText = "AGORA: " + txt;
                            document.getElementById('meta-epg').classList.remove('hide');
                            document.getElementById('meta-desc').innerText = atob(e.description) || "Sem descri√ß√£o.";
                        } else {
                            document.getElementById('meta-epg').innerText = "Sem Informa√ß√£o EPG";
                            document.getElementById('meta-epg').classList.remove('hide');
                        }
                    });
                } else {
                    document.getElementById('vod-prog').style.display = 'block';
                }
                
                // Se j√° estiver tocando esse, s√≥ faz fullscreen
                if(this.currentPlayingUrl === url) { 
                     // Opcional: Se quiser ir pra fullscreen ao clicar 2x
                     // this.toggleFull(); 
                     return; 
                }

                this.currentPlayingUrl = url;
                
                PlayerEngine.play(url, this.mode === 'live');
                var all=document.querySelectorAll('.item');
                for(var i=0;i<all.length;i++) all[i].classList.remove('playing-item');
                if(document.getElementById('it'+this.idx)) document.getElementById('it'+this.idx).classList.add('playing-item');
                
                // REMOVIDO: Auto-fullscreen timer. Agora s√≥ abre no preview.
            },

            back: function() {
                var v = document.getElementById('vid-box');
                
                // 1. Se estiver em Fullscreen, sai do fullscreen
                if(v.classList.contains('fs')) { 
                    this.exitFull(); 
                    return; 
                }

                // 2. Se estiver no Player (zone 3), volta para a lista (zone 2)
                if(this.zone===3) { 
                    this.zone=2; 
                    this.updateFocus(); 
                    return; 
                }

                // 3. Se estiver dentro de uma pasta (S√©ries), volta pra lista de s√©ries
                if(this.zone===2 && this.isFolder) {
                    this.isFolder = false; 
                    this.renderList(this.fullData); 
                    this.idx = this.memIdx; // Recupera onde estava
                    document.getElementById('meta-title').innerText = "S√âRIES";
                    this.updateFocus(); 
                    return;
                }

                // 4. Se estiver na Lista de Canais (zone 2), volta para Categorias (zone 0)
                // IMPORTANTE: N√ÉO PARA O PLAYER AQUI
                if(this.zone===2) { 
                    // this.resetInfo(); // N√ÉO reseta info pra manter o player rodando visualmente ok
                    this.zone=0; 
                    this.idx=this.lastCatIdx; // Volta pra categoria que estava selecionada
                    this.updateFocus(); 
                    return; 
                }

                // 5. Se estiver na busca
                if(this.zone===1) {
                    this.zone=2; this.idx=0; this.updateFocus(); return;
                }

                // 6. Se estiver nas Categorias (zone 0), volta pro Dashboard
                if(this.zone===0) { 
                    this.setScr(1); 
                    return; 
                }
            },

            toggleFull: function() {
                var b = document.getElementById('vid-box');
                if(b.classList.contains('fs')) this.exitFull();
                else { b.classList.add('fs'); this.osd("TELA CHEIA"); }
            },
            exitFull: function() { document.getElementById('vid-box').classList.remove('fs'); },
            
            osd: function(m) {
                var o = document.getElementById('osd'); o.innerText=m; o.style.display='block';
                setTimeout(function(){o.style.display='none'}, 2000);
            },

            toggleFav: function() {
                if(this.scr===2 && this.zone===2 && !this.isFolder) {
                    var item = this.fullData[this.idx];
                    if(item) {
                        var id = item.stream_id || item.series_id;
                        FavManager.toggle(id);
                        this.osd(FavManager.isFav(id) ? "ADICIONADO ‚≠ê" : "REMOVIDO");
                        // Refresh visual simples
                        var el = document.getElementById('it'+this.idx);
                        if(el) el.innerHTML = (item.name||item.title) + (FavManager.isFav(id) ? '<i class="fas fa-star fav-icon"></i>' : '');
                    }
                }
            },

            updateFocus: function() {
                var all=document.querySelectorAll('.focused');
                for(var i=0;i<all.length;i++) all[i].classList.remove('focused');
                var el=null;
                if(this.scr===0) el=document.getElementById('i'+this.idx);
                if(this.scr===1) el=document.getElementById('m'+this.idx);
                if(this.scr===2) {
                    if(this.zone===0) el=document.getElementById('c'+this.idx);
                    if(this.zone===1) el=document.getElementById('search');
                    if(this.zone===2) el=document.getElementById('it'+this.idx);
                    if(this.zone===3) el=document.getElementById('vid-box');
                }
                if(el) {
                    el.classList.add('focused');
                    el.focus();
                    if(el.tagName!=='INPUT') el.scrollIntoView({block:'center', behavior: 'smooth'});
                    
                    // Auto-load EPG on focus (opcional, pode pesar se for muito r√°pido)
                    if(this.zone===2 && !this.isFolder && this.mode==='live') {
                         // Pode implementar preview de EPG aqui se quiser
                    }
                }
            },
            
            move: function(d) {
                if(this.scr===0) { 
                    if(d===1 && this.idx<3) this.idx++; if(d===0 && this.idx>0) this.idx--; 
                }
                if(this.scr===1) { if(d===3 && this.idx<3) this.idx++; if(d===2 && this.idx>0) this.idx--; }
                if(this.scr===2) {
                    if(this.zone===3) {
                        // No player, setas mudam volume ou avan√ßam? 
                        // Por enquanto, esquerda sai do player pro menu
                        if(d===2) { this.zone=2; this.updateFocus(); }
                        return;
                    }
                    if(this.zone===0) { 
                        var max = document.querySelectorAll('.cat-item').length - 1;
                        if(d===1 && this.idx<max) this.idx++; 
                        if(d===0 && this.idx>0) this.idx--; 
                        if(d===3) { this.loadContent(this.idx); }
                    }
                    else if(this.zone===2) {
                        var max = this.fullData.length - 1;
                        // Scroll infinito ou trava? Trava.
                        if(d===1 && this.idx<max) this.idx++; 
                        if(d===0 && this.idx>0) this.idx--;
                        if(d===2) { this.zone=0; this.idx=this.lastCatIdx; } // Volta pra cat selecionada
                        if(d===3) this.zone=3; // Vai pro player
                        if(d===0 && this.idx===0) this.zone=1; // Sobe pra busca
                    }
                    else if(this.zone===1) { 
                        if(d===1) { this.zone=2; this.idx=0; }
                    }
                }
                this.updateFocus();
            },
            
            action: function() {
                if(this.scr===0) this.login();
                if(this.scr===1) { var m=['live','movie','series']; if(this.idx<3) this.openMode(m[this.idx]); else this.logout(); }
                if(this.scr===2) {
                    if(this.zone===0) this.loadContent(this.idx);
                    else if(this.zone===2) this.clickItem();
                    else if(this.zone===3) { this.toggleFull(); }
                }
            }
        };

        // --- CONTROLES GLOBAIS ---
        document.addEventListener('keydown', function(e){
            var k=e.keyCode;
            
            // Tecla 0 (Favoritar)
            if(k===48 || k===96) { App.toggleFav(); }
            
            // Fullscreen Controls
            if(document.getElementById('vid-box').classList.contains('fs')) {
                e.preventDefault(); 
                var v = document.getElementById('player');
                if(k === 13) { 
                    if(App.mode === 'live') { App.toggleFull(); } // Live: OK sai do full
                    else { if(v.paused) v.play(); else v.pause(); } // VOD: OK pausa/play
                    return;
                }
                if(k === 8 || k === 27 || k === 461) { App.toggleFull(); return; }
                
                // Seek VOD
                if(App.mode !== 'live') {
                    if(k===37) v.currentTime-=15; 
                    if(k===39) v.currentTime+=15;
                }
                return; 
            }

            if(App.scr === 0) {
                if(document.activeElement.tagName === 'INPUT' && (k===38 || k===40)) {
                    e.preventDefault(); App.move(k===40?1:0); return; 
                }
                if(k===13 && document.activeElement.tagName === 'BUTTON') {
                    e.preventDefault(); App.action(); return;
                }
                if(k===13) return; 
            }

            if(App.scr === 2 && document.activeElement.id === 'search') {
                if(k === 40) { e.preventDefault(); document.getElementById('search').blur(); App.zone = 2; App.idx = 0; App.updateFocus(); return; }
                if(k === 13) { App.doSearch(); return; }
                return; 
            }

            // RED BUTTON (403) -> Fullscreen
            if(k===403||k===82) { e.preventDefault(); if(App.scr===2) App.toggleFull(); return; }
            
            if(k===404||k===71) { e.preventDefault(); if(App.scr===2){App.zone=0;App.idx=0;App.updateFocus();} return; } // Green
            if(k===405||k===89) { e.preventDefault(); if(App.scr===2){App.zone=1;App.updateFocus();} return; } // Yellow
            if(k===406||k===66||k===77) { e.preventDefault(); App.setScr(1); return; } // Blue (Menu)
            
            // Navega√ß√£o Padr√£o
            if([37,38,39,40,13].indexOf(k)>-1) {
                if(document.activeElement.id==='search' && k!==13 && k!==40) return;
                e.preventDefault();
                if(k===13) App.action(); else if(k===38) App.move(0); else if(k===40) App.move(1); else if(k===37) App.move(2); else if(k===39) App.move(3);
            }
            if(k===8||k===461||k===27) { 
                e.preventDefault(); 
                if(App.scr === 0) return; 
                App.back(); 
            }
        });
    </script>
</body>
</html>
