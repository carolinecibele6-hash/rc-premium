<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>R&C GOLD - PHILCO NETRANGE</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>

    <style>
        /* --- TEMA ORIGINAL RESTAURADO (VISUAL PREMIUM) --- */
        :root { 
            --bg: #000000; 
            --gold: #FFD700; 
            --card-bg: linear-gradient(145deg, #1a1a1a, #0d0d0d);
            --focus-grad: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; outline: none; user-select: none; -webkit-tap-highlight-color: transparent; }
        
        body {
            background-color: var(--bg); 
            color: #fff;
            font-family: 'Montserrat', sans-serif;
            width: 100vw; height: 100vh; overflow: hidden;
            background-image: radial-gradient(circle at 50% 0%, #222 0%, #000 70%);
        }

        .hide { display: none !important; }
        .flex-center { display: flex; align-items: center; justify-content: center; }
        .layer { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 10; background: #000; }

        /* CURSOR M√ÉOZINHA PARA PC */
        button, .smart-card, .cat-item, .item, .power-btn, .key { cursor: pointer; }

        /* FOCO PADR√ÉO (VOLTOU AO ORIGINAL COM SOMBRA FORTE) */
        .focused {
            border: 3px solid #fff !important;
            background: var(--focus-grad) !important;
            color: #000 !important;
            transform: scale(1.05);
            z-index: 50;
            box-shadow: 0 0 30px rgba(255, 215, 0, 0.5);
        }
        
        /* CORRE√á√ÉO DO PLAYER */
        #vid-box.focused {
            transform: none !important;
            border: 4px solid var(--gold) !important;
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.8);
            z-index: 60;
        }

        /* FULLSCREEN */
        #vid-box.fs, #vid-box.fs.focused {
            transform: none !important;
            border: none !important;
            box-shadow: none !important;
            position: fixed !important;
            top: 0 !important; left: 0 !important;
            width: 100vw !important; height: 100vh !important;
            z-index: 9999 !important;
        }

        .focused i, .focused span, .focused div { color: #000 !important; }

        /* LOGIN RESPONSIVO */
        .login-box { 
            width: 400px; max-width: 90%; padding: 40px; 
            background: #111; border: 1px solid #333; 
            border-radius: 12px; text-align: center; 
        }
        .logo-txt { font-size: 32px; font-weight: 900; letter-spacing: -1px; color:#fff; }
        .logo-txt span { color: var(--gold); }
        .inp { width: 100%; padding: 14px; margin: 10px 0; background: #222; border: 1px solid #444; color: #fff; text-align: center; font-weight: bold; border-radius: 6px; }
        .btn { width: 100%; padding: 14px; margin-top: 20px; background: var(--gold); color: #000; border: none; cursor: pointer; text-transform: uppercase; font-weight: 900; border-radius: 6px; }

        /* DASHBOARD */
        #dash-layer { 
            display: flex; flex-direction: column; 
            padding: 40px 60px;
            justify-content: space-between;
        }

        /* Ajustes Mobile Dashboard */
        @media (max-width: 768px) {
            #dash-layer { padding: 20px; }
            .dash-grid { flex-direction: column; gap: 20px; overflow-y: auto; }
            .smart-card { width: 100%; height: 100px; flex-direction: row; gap: 20px; }
            .smart-card i { margin-bottom: 0; font-size: 40px; }
            .col-cat { width: 30%; } 
            .col-list { width: 70%; border: none; }
            .col-play { position: fixed; bottom: 0; left: 0; width: 100%; height: auto; z-index: 100; border-top: 2px solid #333; }
            .vid-box { height: 200px; }
            .meta { display: none; }
            #content-layer { flex-wrap: wrap; }
        }

        .top-bar { display: flex; justify-content: space-between; align-items: center; height: 80px; }
        .dash-logo { font-size: 40px; font-weight: 900; letter-spacing: -2px; }
        .dash-logo span { color: var(--gold); }
        
        .dash-clock { text-align: center; }
        .clock-time { font-size: 28px; font-weight: 700; color: #fff; }
        .clock-date { font-size: 14px; color: #888; text-transform: uppercase; font-weight: 600; margin-top: 5px; }

        .power-btn { 
            font-size: 28px; color: #666; padding: 15px; 
            border-radius: 50%; transition: all 0.2s; border: 2px solid transparent;
        }
        .power-btn.focused { border-radius: 50%; width: 60px; height: 60px; display: flex; align-items: center; justify-content: center; }

        .dash-grid { 
            display: flex; gap: 40px; justify-content: center; align-items: center; flex: 1; 
        }
        .smart-card { 
            width: 280px; height: 320px;
            background: var(--card-bg);
            border: 2px solid #333;
            border-radius: 20px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            transition: transform 0.2s;
            box-shadow: 0 10px 20px rgba(0,0,0,0.5);
        }
        .smart-card i { font-size: 80px; margin-bottom: 30px; color: #555; }
        .smart-card span { font-size: 20px; font-weight: 800; text-transform: uppercase; letter-spacing: 2px; color: #ccc; }

        .bottom-bar { display: flex; justify-content: space-between; align-items: flex-end; }
        .info-pill { 
            background: rgba(255, 255, 255, 0.05); 
            padding: 10px 25px; border-radius: 30px; 
            border: 1px solid #333;
        }
        .lbl { font-size: 11px; color: #888; font-weight: 700; text-transform: uppercase; display: block; margin-bottom: 3px; }
        .val { font-size: 16px; color: var(--gold); font-weight: 800; }

        /* CONTE√öDO */
        #content-layer { display: flex; }
        .col-cat { width: 25%; background: #0b0b0b; border-right: 1px solid #222; display: flex; flex-direction: column; }
        .cat-head { padding: 20px; background: #111; color: var(--gold); font-weight: 900; text-align: center; border-bottom: 2px solid var(--gold); }
        .cat-list { flex: 1; overflow-y: auto; }
        .cat-item { padding: 15px 25px; border-bottom: 1px solid #1a1a1a; color: #999; font-size: 14px; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: block; }
        .cat-item.active { border-left: 5px solid var(--gold); background: #181818; color: #fff; }

        .col-list { width: 35%; background: #111; border-right: 1px solid #222; display: flex; flex-direction: column; }
        .search-area { padding: 15px; background: #080808; border-bottom: 1px solid #333; display: flex; align-items: center; }
        .inp-search { width: 100%; background: #222; border: 1px solid #333; color: #fff; padding: 12px; text-align: center; font-weight: bold; border-radius: 6px; text-transform: uppercase; }
        .item-list { flex: 1; overflow-y: auto; }
        .item { padding: 15px 25px; border-bottom: 1px solid #1a1a1a; color: #bbb; font-size: 15px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: block; }
        .item.playing { color: var(--gold); font-weight: bold; background: #181818; border-left: 3px solid var(--gold); }
        .fav-icon { float: right; color: var(--gold); margin-left: 10px; }

        .col-play { flex: 1; background: #000; display: flex; flex-direction: column; position: relative; }
        
        /* Vid-box Base */
        .vid-box { width: 100%; height: 45vh; background: #000; position: relative; border-bottom: 2px solid #333; }
        
        video { width: 100%; height: 100%; background: #000; object-fit: contain !important; }
        
        .meta { padding: 30px; flex: 1; background: #080808; display: flex; flex-direction: column; overflow: hidden; }
        .meta-title { font-size: 24px; color: var(--gold); font-weight: 800; margin-bottom: 10px; }
        .meta-epg { font-size: 13px; background: #222; color: #fff; padding: 5px 10px; border-radius: 4px; display: inline-block; margin-bottom: 15px; }
        .meta-desc { font-size: 14px; color: #777; overflow-y: auto; flex: 1; line-height: 1.5; }
        .keys { display: flex; gap: 20px; margin-top: 20px; padding-top: 20px; border-top: 1px solid #222; flex-wrap: wrap; }
        .key { font-size: 12px; font-weight: bold; color: #aaa; text-transform: uppercase; display: flex; align-items: center; gap: 8px; }
        .dot { width: 12px; height: 12px; border-radius: 50%; }

        #loader { background: rgba(0,0,0,0.95); z-index: 20000; flex-direction: column; color: var(--gold); font-weight: 900; }
        
        .osd-status { 
            position: absolute; top: 20px; right: 20px; 
            background: rgba(0,0,0,0.8); 
            color: var(--gold) !important; 
            padding: 10px 20px; border-radius: 5px; 
            font-weight: 800; display: none; 
            border: 1px solid var(--gold); 
            z-index: 10000; pointer-events: none;
        }
        
        /* Status de conex√£o */
        .connection-status {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.8);
            color: #fff;
            padding: 8px 15px;
            border-radius: 5px;
            font-size: 12px;
            font-weight: 600;
            display: none;
            z-index: 10001;
            border-left: 4px solid #FFD700;
        }
        
        .connection-status.good { border-left-color: #00C851; }
        .connection-status.warning { border-left-color: #FFBB33; }
        .connection-status.bad { border-left-color: #FF4444; }
        
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 2px; }
    </style>
</head>
<body onload="App.init()">

    <div id="loader" class="hide flex-center">
        <i class="fas fa-circle-notch fa-spin" style="font-size:50px; margin-bottom:20px"></i>
        <div id="load-txt">CARREGANDO...</div>
    </div>

    <div id="login-layer" class="layer flex-center">
        <div class="login-box">
            <div class="logo-txt">R&C <span>GOLD</span></div>
            <input type="text" id="i0" class="inp focusable" placeholder="URL DNS" autocomplete="off">
            <input type="text" id="i1" class="inp focusable" placeholder="USU√ÅRIO" autocomplete="off">
            <input type="password" id="i2" class="inp focusable" placeholder="SENHA" autocomplete="off">
            <button id="i3" class="btn focusable" onclick="App.login()">CONECTAR</button>
            <div id="msg-login" style="color:red; margin-top:10px; font-size:12px;"></div>
        </div>
    </div>

    <div id="dash-layer" class="layer hide">
        <div class="top-bar">
            <div class="dash-logo">R&C <span>GOLD</span></div>
            <div class="dash-clock">
                <div id="clock-time" class="clock-time">12:00</div>
                <div id="clock-date" class="clock-date">--/--/----</div>
            </div>
            <div id="m3" class="power-btn focusable" onclick="App.logout()">
                <i class="fas fa-power-off"></i>
            </div>
        </div>

        <div class="dash-grid">
            <div id="m0" class="smart-card focusable" onclick="App.openMode('live')">
                <i class="fas fa-tv"></i><span>TV AO VIVO</span>
            </div>
            <div id="m1" class="smart-card focusable" onclick="App.openMode('movie')">
                <i class="fas fa-film"></i><span>FILMES</span>
            </div>
            <div id="m2" class="smart-card focusable" onclick="App.openMode('series')">
                <i class="fas fa-video"></i><span>S√âRIES</span>
            </div>
        </div>

        <div class="bottom-bar">
            <div class="info-pill">
                <span class="lbl">VENCIMENTO</span>
                <span id="info-exp" class="val">...</span>
            </div>
            <div class="info-pill" style="text-align: right;">
                <span class="lbl">TELAS ATIVAS</span>
                <span id="info-conn" class="val">...</span>
            </div>
        </div>
    </div>

    <div id="content-layer" class="layer hide">
        <div class="col-cat">
            <div class="cat-head">CATEGORIAS</div>
            <div id="cat-list" class="cat-list"></div>
        </div>
        <div class="col-list">
            <div class="search-area">
                <input type="text" id="search" class="inp-search focusable" placeholder="PESQUISAR..." autocomplete="off">
            </div>
            <div id="item-list" class="item-list"></div>
        </div>
        <div class="col-play">
            <div id="connection-indicator" class="connection-status hide">
                <i class="fas fa-wifi"></i> <span id="connection-text">CONEX√ÉO EST√ÅVEL</span>
            </div>
            <div id="vid-box" class="vid-box focusable">
                <video id="player" playsinline webkit-playsinline></video>
                <div id="osd" class="osd-status"></div>
            </div>
            <div class="meta">
                <div id="meta-title" class="meta-title">R&C GOLD - PHILCO NETRANGE</div>
                <div id="meta-epg" class="meta-epg hide"></div>
                <div id="meta-desc" class="meta-desc">Sistema anti-travamentos ativo. Assista seu futebol sem estresse.</div>
                
                <div class="keys">
                    <div class="key"><div class="dot" style="background:#ff4444"></div> TELA CHEIA</div>
                    <div class="key"><div class="dot" style="background:#00C851"></div> TOPO</div>
                    <div class="key"><div class="dot" style="background:#ffbb33"></div> BUSCAR</div>
                    <div class="key"><div class="dot" style="background:#33b5e5"></div> MENU</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        var FavManager = {
            key: 'rc_favs_smart', list: [],
            init: function() { var s = localStorage.getItem(this.key); this.list = s ? JSON.parse(s) : []; },
            toggle: function(id) {
                var idx = this.list.indexOf(id);
                if(idx > -1) this.list.splice(idx, 1); else this.list.push(id);
                localStorage.setItem(this.key, JSON.stringify(this.list));
                if(App.idx < App.fullData.length) App.renderList(true);
            },
            isFav: function(id) { return this.list.indexOf(id) > -1; }
        };

        var PlayerEngine = {
            hls: null, video: null, url: null, retryCount: 0, monitorTimer: null, lastTime: 0, 
            stallCount: 0, bufferTimer: null, qualityTimer: null, connectionMonitor: null,
            lastBufferState: null, retryDelay: 1000, maxRetryDelay: 10000,
            init: function() { 
                this.video = document.getElementById('player'); 
                this.video.onerror = function() { PlayerEngine.recover(); };
                this.video.onwaiting = function() { PlayerEngine.onBuffering(); };
                this.video.onplaying = function() { PlayerEngine.onPlaying(); };
                this.video.onstalled = function() { PlayerEngine.onStalled(); };
                this.startConnectionMonitor();
            },
            
            startConnectionMonitor: function() {
                var connectionIndicator = document.getElementById('connection-indicator');
                var connectionText = document.getElementById('connection-text');
                
                this.connectionMonitor = setInterval(function() {
                    if(!PlayerEngine.video || !PlayerEngine.url || PlayerEngine.video.paused) {
                        connectionIndicator.classList.add('hide');
                        return;
                    }
                    
                    var video = PlayerEngine.video;
                    var buffered = video.buffered;
                    var currentTime = video.currentTime;
                    var bufferTime = 0;
                    
                    if(buffered.length > 0) {
                        for(var i = 0; i < buffered.length; i++) {
                            if(buffered.start(i) <= currentTime && buffered.end(i) >= currentTime) {
                                bufferTime = buffered.end(i) - currentTime;
                                break;
                            }
                        }
                    }
                    
                    var networkState = video.networkState;
                    var readyState = video.readyState;
                    
                    // Classifica√ß√£o da conex√£o
                    if(bufferTime > 10) {
                        connectionIndicator.classList.remove('hide');
                        connectionIndicator.className = 'connection-status good';
                        connectionText.innerHTML = '<i class="fas fa-wifi"></i> CONEX√ÉO EXCELENTE';
                    } else if(bufferTime > 5) {
                        connectionIndicator.classList.remove('hide');
                        connectionIndicator.className = 'connection-status warning';
                        connectionText.innerHTML = '<i class="fas fa-wifi"></i> CONEX√ÉO BOA';
                    } else if(bufferTime > 2) {
                        connectionIndicator.classList.remove('hide');
                        connectionIndicator.className = 'connection-status warning';
                        connectionText.innerHTML = '<i class="fas fa-wifi"></i> CONEX√ÉO REGULAR';
                    } else if(bufferTime > 0) {
                        connectionIndicator.classList.remove('hide');
                        connectionIndicator.className = 'connection-status bad';
                        connectionText.innerHTML = '<i class="fas fa-exclamation-triangle"></i> CONEX√ÉO FRACA';
                    } else {
                        connectionIndicator.classList.remove('hide');
                        connectionIndicator.className = 'connection-status bad';
                        connectionText.innerHTML = '<i class="fas fa-exclamation-circle"></i> SEM BUFFER';
                    }
                    
                    // Atualizar texto com informa√ß√µes detalhadas
                    connectionText.innerHTML += ' | Buffer: ' + bufferTime.toFixed(1) + 's';
                    
                }, 2000);
            },
            
            onBuffering: function() {
                App.osd("BUFFERANDO...");
                this.stallCount++;
                if(this.stallCount > 3) {
                    this.recover();
                }
            },
            
            onPlaying: function() {
                this.stallCount = 0;
                this.retryDelay = 1000; // Resetar delay de retry
            },
            
            onStalled: function() {
                App.osd("SINAL TRAVADO");
                this.stallCount += 2;
                if(this.stallCount > 2) {
                    this.recover();
                }
            },
            
            play: function(url, isLive) {
                if(this.url === url && !this.video.paused) return;
                
                this.stop(); 
                this.url = url; 
                this.retryCount = 0; 
                this.stallCount = 0;
                this.retryDelay = 1000;
                
                this.video.controls = false; 
                
                if(isLive) {
                    this.video.classList.add('live');
                    // For√ßar .m3u8 para HLS
                    if(url.indexOf('.m3u8') === -1 && (url.indexOf('.ts') > -1 || url.indexOf('live') > -1)) {
                        url = url.replace('.ts', '.m3u8').replace(/\.(mp4|avi|mkv)$/, '.m3u8');
                    }
                } else {
                    this.video.classList.remove('live');
                }

                // CONFIGURA√á√ÉO ESPECIAL PARA PHILCO NETRANGE - OTIMIZADO PARA FUTEBOL
                var canPlayNative = this.video.canPlayType('application/vnd.apple.mpegurl');
                if (canPlayNative === "probably" || canPlayNative === "maybe") {
                    // Configura√ß√µes para player nativo
                    this.video.preload = "auto";
                    this.video.playsInline = true;
                    this.video.muted = false;
                    this.video.src = url; 
                    
                    var playPromise = this.video.play();
                    if (playPromise !== undefined) {
                        playPromise.catch(function(e){ 
                            if(Hls.isSupported()) PlayerEngine.startHls(url); 
                            else PlayerEngine.video.muted = true;
                            PlayerEngine.video.play().catch(e => console.log("Fallback play error:", e));
                        });
                    }
                } else if (Hls.isSupported()) {
                    this.startHls(url);
                } else {
                    this.video.src = url; 
                    this.video.play().catch(e => {
                        console.log("Direct play error:", e);
                        this.video.muted = true;
                        this.video.play().catch(e2 => console.log("Muted play error:", e2));
                    });
                }
                
                // Iniciar monitoramento avan√ßado
                this.startAdvancedMonitor();
            },
            
            startHls: function(url) {
                if(this.hls) this.hls.destroy();
                
                // CONFIGURA√á√ÉO TURBO ESPECIAL PARA FUTEBOL NA PHILCO NETRANGE
                var config = { 
                    enableWorker: true,
                    lowLatencyMode: true,
                    backBufferLength: 90,
                    maxBufferLength: 60,
                    maxMaxBufferLength: 120,
                    maxBufferSize: 60 * 1000 * 1000, // 60MB
                    maxBufferHole: 0.5,
                    maxFragLookUpTolerance: 0.2,
                    manifestLoadingTimeOut: 15000,
                    manifestLoadingMaxRetry: 4,
                    manifestLoadingRetryDelay: 1000,
                    manifestLoadingMaxRetryTimeout: 15000,
                    levelLoadingTimeOut: 20000,
                    levelLoadingMaxRetry: 6,
                    levelLoadingRetryDelay: 1000,
                    levelLoadingMaxRetryTimeout: 60000,
                    fragLoadingTimeOut: 20000,
                    fragLoadingMaxRetry: 6,
                    fragLoadingRetryDelay: 1000,
                    fragLoadingMaxRetryTimeout: 60000,
                    startLevel: -1,
                    capLevelToPlayerSize: true,
                    capLevelOnFPSDrop: true,
                    fpsDroppedMonitoringPeriod: 5000,
                    fpsDroppedMonitoringThreshold: 0.2,
                    autoStartLoad: true,
                    startPosition: -1,
                    defaultAudioCodec: undefined,
                    initialLiveManifestSize: 1,
                    maxLiveSyncPlaybackRate: 1.5,
                    enableSoftwareAES: true,
                    stretchShortVideoTrack: true,
                    forceKeyFrameOnDiscontinuity: true,
                    abrEwmaDefaultEstimate: 500000,
                    abrEwmaFastLive: 3,
                    abrEwmaSlowLive: 9,
                    abrEwmaFastVoD: 3,
                    abrEwmaSlowVoD: 9,
                    abrEwmaDefaultEstimateMax: 500000,
                    abrBandWidthFactor: 0.95,
                    abrBandWidthUpFactor: 0.7,
                    abrMaxWithRealBitrate: true,
                    maxStarvationDelay: 4,
                    maxLoadingDelay: 4,
                    minAutoBitrate: 0
                };
                
                this.hls = new Hls(config);
                this.hls.loadSource(url);
                this.hls.attachMedia(this.video);
                
                this.hls.on(Hls.Events.MANIFEST_PARSED, function() { 
                    PlayerEngine.video.play().catch(function(e){
                        PlayerEngine.video.muted = true;
                        PlayerEngine.video.play().catch(e2 => console.log(e2));
                    }); 
                });
                
                this.hls.on(Hls.Events.ERROR, function(event, data) {
                    console.log("HLS Error:", data.type, data.details);
                    
                    if (data.fatal) {
                        switch(data.type) {
                            case Hls.ErrorTypes.NETWORK_ERROR:
                                PlayerEngine.onNetworkError(data);
                                break;
                            case Hls.ErrorTypes.MEDIA_ERROR:
                                PlayerEngine.onMediaError(data);
                                break;
                            default:
                                PlayerEngine.recover();
                                break;
                        }
                    } else {
                        // Erros n√£o fatais - apenas log
                        if(data.details === Hls.ErrorDetails.BUFFER_STALLED_ERROR) {
                            PlayerEngine.onBuffering();
                        }
                    }
                });
                
                this.hls.on(Hls.Events.FRAG_BUFFERED, function(event, data) {
                    PlayerEngine.stallCount = 0; // Resetar contador quando bufferiza
                });
                
                this.hls.on(Hls.Events.LEVEL_LOADED, function(event, data) {
                    App.osd("QUALIDADE: " + (data.details.totalbitrate / 1000).toFixed(0) + "kbps");
                });
            },
            
            onNetworkError: function(data) {
                if(data.details === Hls.ErrorDetails.MANIFEST_LOAD_ERROR || 
                   data.details === Hls.ErrorDetails.LEVEL_LOAD_ERROR ||
                   data.details === Hls.ErrorDetails.FRAG_LOAD_ERROR) {
                    this.recover();
                } else {
                    this.hls.startLoad();
                }
            },
            
            onMediaError: function(data) {
                if(data.details === Hls.ErrorDetails.MANIFEST_INCOMPATIBLE_CODECS_ERROR) {
                    App.osd("CODEC INCOMPAT√çVEL - TENTANDO NATIVO");
                    this.hls.destroy();
                    this.hls = null;
                    this.video.src = this.url;
                    this.video.play().catch(e => console.log(e));
                } else {
                    this.hls.recoverMediaError();
                }
            },
            
            startAdvancedMonitor: function() {
                this.stopMonitor();
                
                // Monitor de buffer
                this.bufferTimer = setInterval(function() {
                    var v = PlayerEngine.video;
                    if(!v || !PlayerEngine.url || v.paused) return;
                    
                    var buffered = v.buffered;
                    var currentTime = v.currentTime;
                    var hasBuffer = false;
                    
                    if(buffered.length > 0) {
                        for(var i = 0; i < buffered.length; i++) {
                            if(buffered.start(i) <= currentTime && buffered.end(i) >= currentTime) {
                                hasBuffer = true;
                                var bufferEnd = buffered.end(i);
                                var bufferAhead = bufferEnd - currentTime;
                                
                                // Se buffer muito baixo, tentar antecipar
                                if(bufferAhead < 2 && !v.seeking) {
                                    PlayerEngine.stallCount++;
                                    if(PlayerEngine.stallCount > 2) {
                                        App.osd("BUFFER BAIXO - OTIMIZANDO...");
                                        // Tentar pular para √°rea com mais buffer
                                        v.currentTime = Math.min(v.currentTime + 0.5, v.duration);
                                    }
                                } else {
                                    PlayerEngine.stallCount = Math.max(0, PlayerEngine.stallCount - 0.5);
                                }
                                break;
                            }
                        }
                    }
                    
                    // Se n√£o tem buffer e n√£o est√° pausado, problema!
                    if(!hasBuffer && !v.paused && v.readyState >= 2) {
                        PlayerEngine.stallCount++;
                        if(PlayerEngine.stallCount > 3) {
                            PlayerEngine.recover();
                        }
                    }
                    
                    // Monitor de FPS para detectar travamentos
                    if(Math.abs(v.currentTime - PlayerEngine.lastTime) < 0.01 && !v.paused) {
                        PlayerEngine.stallCount += 0.5;
                    } else {
                        PlayerEngine.lastTime = v.currentTime;
                        PlayerEngine.stallCount = Math.max(0, PlayerEngine.stallCount - 0.2);
                    }
                    
                }, 1000);
                
                // Monitor de qualidade (mais lento)
                this.qualityTimer = setInterval(function() {
                    if(!PlayerEngine.video || PlayerEngine.video.paused) return;
                    
                    var v = PlayerEngine.video;
                    var isSmooth = true;
                    
                    // Verificar se o v√≠deo est√° "travando" (FPS muito baixo)
                    if(v.readyState >= 3) {
                        var timeDiff = v.currentTime - PlayerEngine.lastTime;
                        if(timeDiff < 0.1 && !v.paused) {
                            isSmooth = false;
                        }
                    }
                    
                    if(!isSmooth && PlayerEngine.hls) {
                        var currentLevel = PlayerEngine.hls.currentLevel;
                        var levels = PlayerEngine.hls.levels;
                        
                        // Se qualidade muito alta, reduzir
                        if(currentLevel > 0 && levels && levels.length > 1) {
                            var newLevel = Math.max(0, currentLevel - 1);
                            PlayerEngine.hls.currentLevel = newLevel;
                            App.osd("QUALIDADE REDUZIDA PARA FLUIDEZ");
                        }
                    }
                    
                }, 5000);
            },
            
            stopMonitor: function() { 
                if(this.bufferTimer) clearInterval(this.bufferTimer); 
                if(this.qualityTimer) clearInterval(this.qualityTimer); 
                this.bufferTimer = null;
                this.qualityTimer = null;
            },
            
            recover: function() {
                this.retryCount++;
                
                if(this.retryCount > 10) { 
                    this.stop(); 
                    App.osd("FALHA DE SINAL - TENTE NOVAMENTE"); 
                    return; 
                }
                
                App.osd("RECUPERANDO... TENTATIVA " + this.retryCount);
                
                // Backoff exponencial
                var delay = Math.min(this.retryDelay * Math.pow(1.5, this.retryCount - 1), this.maxRetryDelay);
                this.retryDelay = delay;
                
                setTimeout(function(){ 
                    PlayerEngine.stop(); 
                    
                    setTimeout(function(){ 
                        if(App.mode === 'live' || PlayerEngine.url.includes('.m3u8')) {
                            // Tentar reconectar com URL limpa
                            var originalUrl = PlayerEngine.url;
                            var cleanUrl = originalUrl.split('?')[0]; // Remover par√¢metros
                            
                            // Se for HLS, for√ßar reload
                            if(PlayerEngine.hls) {
                                PlayerEngine.hls.destroy();
                                PlayerEngine.hls = null;
                            }
                            
                            var v = document.getElementById('player'); 
                            v.load(); 
                            
                            // Pequena varia√ß√£o na URL para evitar cache
                            var timestamp = new Date().getTime();
                            var recoverUrl = cleanUrl + (cleanUrl.includes('?') ? '&' : '?') + '_t=' + timestamp;
                            
                            PlayerEngine.play(recoverUrl, true);
                        }
                    }, 500); 
                    
                }, delay);
            },
            
            stop: function() { 
                this.stopMonitor(); 
                if(this.hls) { 
                    try { this.hls.destroy(); } catch(e) {} 
                    this.hls = null; 
                } 
                if(this.video) { 
                    this.video.pause(); 
                    this.video.removeAttribute('src'); // Limpeza de mem√≥ria
                    this.video.load(); 
                } 
            },
            
            destroy: function() {
                this.stop();
                if(this.connectionMonitor) {
                    clearInterval(this.connectionMonitor);
                    this.connectionMonitor = null;
                }
            }
        };

        var App = {
            scr: 0, zone: 0, idx: 0, lastCatIdx: 0, creds: {}, fullData: [], storedList: [], memIdx: 0, globalData: null, isFolder: false, seriesEps: [], playingId: null,

            init: function() {
                FavManager.init();
                if(localStorage.getItem('rc_h')) {
                    document.getElementById('i0').value = localStorage.getItem('rc_h');
                    document.getElementById('i1').value = localStorage.getItem('rc_u');
                    document.getElementById('i2').value = localStorage.getItem('rc_p');
                }
                PlayerEngine.init();
                document.getElementById('player').onended = function() { 
                    if(App.mode==='series' && App.isFolder && App.idx < App.seriesEps.length-1) {
                        App.idx++; App.updateFocus(); App.playStream(App.seriesEps[App.idx]);
                    } else App.exitFull(); 
                };
                setInterval(this.updateClock, 1000);
                this.updateClock();
                this.updateFocus();
            },

            updateClock: function() {
                var now = new Date();
                var h = now.getHours(); var m = now.getMinutes();
                if(m<10) m='0'+m;
                var strTime = h + ":" + m;
                var strDate = now.toLocaleDateString('pt-BR', { weekday: 'long', day: 'numeric', month: 'long' });
                var elT = document.getElementById('clock-time'); if(elT) elT.innerText = strTime;
                var elD = document.getElementById('clock-date'); if(elD) elD.innerText = strDate;
            },

            req: function(url, cb) {
                var x = new XMLHttpRequest(); x.open("GET", url, true); x.timeout = 25000;
                x.onload = function() { if(x.status===200) { try{cb(JSON.parse(x.responseText));}catch(e){cb(null);} } else cb(null); };
                x.onerror = function(){ cb('ERR_NET'); }; 
                x.send();
            },

            login: function() {
                var h = document.getElementById('i0').value.trim();
                var u = document.getElementById('i1').value.trim();
                var p = document.getElementById('i2').value.trim();
                
                if(h.endsWith('/')) h = h.slice(0, -1);
                if(h.indexOf('http') === -1) h = 'http://' + h;
                
                document.getElementById('loader').classList.remove('hide');
                document.getElementById('load-txt').innerText = "CONECTANDO...";
                
                this.req(h+"/player_api.php?username="+u+"&password="+p, function(d){
                    document.getElementById('loader').classList.add('hide');
                    if(d === 'ERR_NET') {
                        document.getElementById('msg-login').innerHTML = "Falha de Conex√£o!<br>Se for PC, instale extens√£o CORS.";
                        return;
                    }
                    if(d && d.user_info && d.user_info.auth==1) {
                        App.creds={h:h,u:u,p:p};
                        localStorage.setItem('rc_h', h); localStorage.setItem('rc_u', u); localStorage.setItem('rc_p', p);
                        var info = d.user_info;
                        var exp = info.exp_date ? new Date(info.exp_date*1000).toLocaleDateString("pt-BR") : "Ilimitado";
                        var conn = (info.active_cons || 0) + " / " + (info.max_connections || 1);
                        document.getElementById('info-exp').innerText = exp;
                        document.getElementById('info-conn').innerText = conn;
                        App.setScr(1);
                    } else document.getElementById('msg-login').innerText="Usu√°rio/Senha Inv√°lidos";
                });
            },
            logout: function() { localStorage.clear(); PlayerEngine.destroy(); location.reload(); },

            setScr: function(n) {
                if(n===1) { PlayerEngine.stop(); }
                document.querySelectorAll('.layer').forEach(function(l){l.classList.add('hide')});
                if(n===0) document.getElementById('login-layer').classList.remove('hide');
                if(n===1) document.getElementById('dash-layer').classList.remove('hide');
                if(n===2) document.getElementById('content-layer').classList.remove('hide');
                this.scr=n; this.zone=0; this.idx=0; this.updateFocus();
            },

            openMode: function(m) {
                PlayerEngine.stop(); this.resetInfo();
                this.mode = m; this.setScr(2); this.isFolder = false; this.globalData = null; this.playingId = null;
                document.getElementById('cat-list').innerHTML = ''; document.getElementById('item-list').innerHTML = '';
                document.getElementById('loader').classList.remove('hide');
                
                document.getElementById('search').value = '';

                var act = (m==='live')?'get_live_categories':(m==='movie'?'get_vod_categories':'get_series_categories');
                this.req(this.creds.h+"/player_api.php?username="+this.creds.u+"&password="+this.creds.p+"&action="+act, function(d){
                    document.getElementById('loader').classList.add('hide');
                    if(d && d!=='ERR_NET') {
                        var h = '<div class="cat-item" id="c0" data-id="fav" onclick="App.catClick(0)">‚≠ê FAVORITOS</div>';
                        for(var i=0;i<d.length;i++) h += '<div class="cat-item" id="c'+(i+1)+'" data-id="'+d[i].category_id+'" onclick="App.catClick('+(i+1)+')">'+d[i].category_name+'</div>';
                        document.getElementById('cat-list').innerHTML = h;
                        App.zone=0; App.idx=0; App.updateFocus();
                    }
                });
            },
            
            resetInfo: function() {
                document.getElementById('meta-title').innerText = "R&C GOLD - PHILCO NETRANGE";
                document.getElementById('meta-desc').innerText = "Sistema anti-travamentos ativo. Assista seu futebol sem estresse.";
                document.getElementById('meta-epg').innerText = "";
                document.getElementById('meta-epg').classList.add('hide');
                var v = document.getElementById('player'); v.removeAttribute('src'); v.load();
            },

            catClick: function(i) { this.idx=i; this.zone=0; this.loadContent(i); },

            loadContent: function(catIdx) {
                this.lastCatIdx = catIdx; 
                var el = document.getElementById('c'+catIdx); if(!el) return;
                var cid = el.getAttribute('data-id');
                document.querySelectorAll('.cat-item').forEach(function(e){e.classList.remove('active')});
                el.classList.add('active');
                
                document.getElementById('search').value = '';

                document.getElementById('loader').classList.remove('hide');
                document.getElementById('item-list').innerHTML = '';

                var onData = function(d) {
                    document.getElementById('loader').classList.add('hide');
                    if(d && d!=='ERR_NET') { App.fullData = d; App.isFolder = false; App.renderList(); }
                };

                if(cid === 'fav') {
                     var act = (this.mode==='live')?'get_live_streams':(this.mode==='movie'?'get_vod_streams':'get_series');
                     this.req(this.creds.h+"/player_api.php?username="+this.creds.u+"&password="+this.creds.p+"&action="+act, function(d){
                        if(d && d!=='ERR_NET') { App.fullData = d.filter(function(x){ return FavManager.isFav(x.stream_id || x.series_id); }); App.isFolder=false; App.renderList(); }
                        document.getElementById('loader').classList.add('hide');
                     });
                } else {
                    var act = (this.mode==='live')?'get_live_streams':(this.mode==='movie'?'get_vod_streams':'get_series');
                    this.req(this.creds.h+"/player_api.php?username="+this.creds.u+"&password="+this.creds.p+"&action="+act+"&category_id="+cid, onData);
                }
            },

            renderList: function(keepIdx) {
                var d = this.fullData;
                var max = d.length > 200 ? 200 : d.length; 
                if(max===0) { document.getElementById('item-list').innerHTML = '<div style="padding:20px;">Vazio</div>'; return; }
                var h = '';
                for(var i=0; i<max; i++) {
                    var n = d[i].name || d[i].title;
                    var id = d[i].stream_id || d[i].series_id;
                    var icn = FavManager.isFav(id) ? '<i class="fas fa-star fav-icon"></i>' : '';
                    h += '<div class="item" id="row-'+i+'" onclick="App.itemClick('+i+')">'+n+icn+'</div>';
                }
                document.getElementById('item-list').innerHTML = h;
                
                this.zone = 2;
                if(!keepIdx) { this.idx = 0; }
                this.updateFocus();
            },

            itemClick: function(i) { this.idx=i; this.zone=2; this.clickItem(); },
            clickItem: function() {
                if(this.isFolder) { this.playStream(this.seriesEps[this.idx]); return; }
                var item = this.fullData[this.idx];
                if(this.mode !== 'series') { if(item) this.playStream(item); return; }
                if(item) {
                    this.storedList = [...this.fullData]; this.memIdx = this.idx;
                    document.getElementById('loader').classList.remove('hide');
                    this.req(this.creds.h+"/player_api.php?username="+this.creds.u+"&password="+this.creds.p+"&action=get_series_info&series_id="+item.series_id, function(d){
                        document.getElementById('loader').classList.add('hide');
                        if(d && d.episodes) {
                            var eps = [];
                            for(var k in d.episodes) for(var j=0; j<d.episodes[k].length; j++) eps.push(d.episodes[k][j]);
                            App.seriesEps = eps; App.fullData = eps; App.isFolder = true; App.renderList();
                            document.getElementById('meta-title').innerText = "üìÇ " + (item.name || item.title);
                        }
                    });
                }
            },

            playStream: function(item) {
                var ext = (this.mode==='live')?'ts':(item.container_extension||'mp4');
                var type = (this.mode==='live')?'live':(this.mode==='movie'?'movie':'series');
                var id = item.stream_id || item.id;
                var url = this.creds.h+"/"+type+"/"+this.creds.u+"/"+this.creds.p+"/"+id+"."+ext;
                
                this.playingId = id; 
                document.getElementById('meta-title').innerText = item.name || item.title;
                document.getElementById('meta-desc').innerText = "Carregando...";
                document.getElementById('meta-epg').classList.add('hide');
                
                // Adicionar timestamp para evitar cache
                url += "?_t=" + new Date().getTime();
                
                if(this.mode === 'live') {
                    this.req(this.creds.h+"/player_api.php?username="+this.creds.u+"&password="+this.creds.p+"&action=get_short_epg&stream_id="+id, function(d){
                        if(d && d.epg_listings && d.epg_listings.length > 0) {
                            var t = d.epg_listings[0].title; try { if(window.atob && /^[A-Za-z0-9+/=]+$/.test(t)) t=atob(t); }catch(e){}
                            document.getElementById('meta-epg').innerText = t; document.getElementById('meta-epg').classList.remove('hide');
                        }
                    });
                }
                PlayerEngine.play(url, this.mode==='live');
                document.querySelectorAll('.item').forEach(function(e){e.classList.remove('playing')});
                var r = document.getElementById('row-'+this.idx); if(r) r.classList.add('playing');
            },

            syncFocusToPlaying: function() {
                if(!this.playingId) return;
                for(var i=0; i<this.fullData.length; i++) {
                    var id = this.fullData[i].stream_id || this.fullData[i].series_id || this.fullData[i].id;
                    if(id == this.playingId) { this.idx = i; this.updateFocus(); return; }
                }
            },

            // --- RESTAURADO: PESQUISA MANUAL (SEM TIMER) ---
            doSearch: function() {
                var t = document.getElementById('search').value.toLowerCase();
                if(t.length < 2) return;
                document.getElementById('item-list').innerHTML = '<div style="padding:20px">Buscando...</div>';
                var cb = function(d) {
                    if(d && d!=='ERR_NET') { 
                        App.fullData = d.filter(function(x){ return (x.name||x.title||"").toLowerCase().indexOf(t) > -1 }); 
                        App.isFolder = false; 
                        App.renderList(); 
                        
                        App.zone = 2; 
                        App.idx = 0; 
                        App.updateFocus();
                    }
                };
                if(App.globalData) cb(App.globalData);
                else {
                    var act = (App.mode==='live')?'get_live_streams':(App.mode==='movie'?'get_vod_streams':'get_series');
                    App.req(App.creds.h+"/player_api.php?username="+App.creds.u+"&password="+App.creds.p+"&action="+act, function(d){ App.globalData=d; cb(d); });
                }
            },
            
            toggleFull: function() {
                var b = document.getElementById('vid-box'); if(b.classList.contains('fs')) this.exitFull(); else { b.classList.add('fs'); App.osd("TELA CHEIA"); }
            },
            exitFull: function() { 
                document.getElementById('vid-box').classList.remove('fs'); 
                this.syncFocusToPlaying();
            },
            osd: function(t) { var o=document.getElementById('osd'); o.innerText=t; o.style.display='block'; setTimeout(function(){o.style.display='none'},2000); },
            
            back: function() {
                if(document.getElementById('vid-box').classList.contains('fs')) { this.exitFull(); return; }
                if(this.zone===3) { this.zone=2; this.syncFocusToPlaying(); this.updateFocus(); return; }
                if(this.zone===2 && this.isFolder) {
                    this.isFolder = false; this.fullData = this.storedList; this.renderList(true); 
                    this.idx = this.memIdx; this.updateFocus(); document.getElementById('meta-title').innerText = "R&C GOLD"; return; 
                }
                if(this.zone===2) { this.zone=0; this.idx=this.lastCatIdx; this.updateFocus(); return; }
                if(this.zone===1) { this.zone=2; this.idx=0; this.updateFocus(); return; }
                if(this.zone===0) { this.setScr(1); return; }
            },
            
            updateFocus: function() {
                document.querySelectorAll('.focused').forEach(function(e){e.classList.remove('focused')});
                var el;
                if(this.scr===0) el=document.getElementById('i'+this.idx);
                if(this.scr===1) el=document.getElementById('m'+this.idx);
                if(this.scr===2) {
                    if(this.zone===0) el=document.getElementById('c'+this.idx);
                    if(this.zone===1) el=document.getElementById('search');
                    if(this.zone===2) el=document.getElementById('row-'+this.idx);
                    if(this.zone===3) el=document.getElementById('vid-box');
                }
                if(el) {
                    el.classList.add('focused'); 
                    if(el.tagName==='INPUT') { 
                        el.focus(); 
                    } else { 
                        document.getElementById('i0').blur();
                        document.getElementById('i1').blur();
                        document.getElementById('i2').blur();
                        document.getElementById('search').blur();
                        el.focus(); 
                    }
                    if(el.tagName!=='INPUT') el.scrollIntoView({block:'center',behavior:'smooth'}); 
                }
            },
            move: function(d) {
                if(this.scr===0) { if(d===1&&this.idx<3) this.idx++; if(d===0&&this.idx>0) this.idx--; }
                if(this.scr===1) { 
                    if(this.idx <= 2) { 
                        if(d===3 && this.idx<2) this.idx++; 
                        if(d===2 && this.idx>0) this.idx--; 
                        if(d===0) { this.idx = 3; } 
                    }
                    else if(this.idx === 3) { 
                        if(d===1) { this.idx = 1; } 
                    }
                }
                if(this.scr===2) {
                    if(this.zone===3) { 
                        if(d===2) { 
                            this.zone=2; 
                            this.syncFocusToPlaying(); 
                            this.updateFocus(); 
                        } return; 
                    }
                    if(this.zone===0) { 
                        var max = document.getElementById('cat-list').children.length-1;
                        if(d===1 && this.idx<max) this.idx++;
                        if(d===0 && this.idx>0) this.idx--;
                        if(d===3 && App.fullData.length>0) { this.zone=2; this.idx=0; }
                    }
                    else if(this.zone===2) { 
                        var max = document.getElementById('item-list').children.length-1;
                        if(d===1 && this.idx<max) this.idx++; 
                        else if(d===0) { 
                            if(this.idx > 0) this.idx--; 
                            else this.zone = 1; 
                        }
                        else if(d===2) { this.zone=0; this.idx=this.lastCatIdx; } 
                        else if(d===3) this.zone=3; 
                    }
                    else if(this.zone===1) { 
                        if(d===1) { this.zone=2; this.idx=0; }
                        if(d===2) { this.zone=0; this.idx=this.lastCatIdx; }
                    }
                }
                this.updateFocus();
            },
            enter: function() {
                if(this.scr===0) this.login();
                if(this.scr===1) { 
                    if(this.idx === 3) this.logout();
                    else this.openMode(['live','movie','series'][this.idx]); 
                }
                if(this.scr===2) {
                    if(this.zone===0) this.loadContent(this.idx);
                    if(this.zone===1) this.doSearch();
                    if(this.zone===2) this.clickItem();
                    if(this.zone===3) {
                        this.toggleFull(); 
                    }
                }
            }
        };

        document.addEventListener('keydown', function(e) {
            var k=e.keyCode;
            
            // --- INPUT RESTAURADO (MANUAL) ---
            if(document.activeElement.tagName === 'INPUT') {
                if(App.scr === 0) {
                    if(k === 13) { e.preventDefault(); App.login(); return; } 
                    if(k === 40) { e.preventDefault(); App.move(1); return; } 
                    if(k === 38) { e.preventDefault(); App.move(0); return; } 
                    return; 
                }
                // Na busca: Enter para buscar, Seta Baixo para sair
                if(App.scr === 2) {
                    if(k === 13) { App.doSearch(); return; } 
                    if(k === 40) { e.preventDefault(); App.zone=2; App.idx=0; App.updateFocus(); return; } 
                    return; 
                }
            }
            // ------------------------------------

            if(App.scr === 0) {
                if(k===13) {
                    e.preventDefault(); 
                    if(App.idx === 3) {
                        document.activeElement.blur(); 
                        App.login();
                    }
                    return;
                }
            }

            // CONTROLES VOD 
            if(App.scr===2 && App.mode!=='live' && document.getElementById('vid-box').classList.contains('fs')) {
                var v = document.getElementById('player');
                if(k===39 || k===417) { v.currentTime += 30; App.osd(">> 30s"); return; } 
                if(k===37 || k===412) { v.currentTime -= 30; App.osd("<< 30s"); return; } 
                if(k===13 || k===415 || k===19 || k===179) { 
                   if(v.paused) { v.play(); App.osd("‚ñ∂ PLAY"); } else { v.pause(); App.osd("‚è∏ PAUSE"); }
                   return;
                }
            }

            if(k===48 || k===96) { if(App.scr===2 && App.zone===2) { var it=App.fullData[App.idx]; if(it) FavManager.toggle(it.stream_id||it.series_id); } }
            if(document.getElementById('vid-box').classList.contains('fs')) { 
                e.preventDefault(); 
                if(k===13||k===403||k===82||k===27||k===461) App.toggleFull(); 
                return; 
            }
            
            if(k===37) { e.preventDefault(); App.move(2); } if(k===38) { e.preventDefault(); App.move(0); }
            if(k===39) { e.preventDefault(); App.move(3); } if(k===40) { e.preventDefault(); App.move(1); }
            if(k===13) { e.preventDefault(); App.enter(); }
            if(k===8||k===27||k===461) { e.preventDefault(); if(App.scr>0) App.back(); }
            
            if(k===403||k===82) if(App.scr===2) App.toggleFull(); 
            if(k===404||k===71) if(App.scr===2) { App.zone=0; App.idx=0; App.updateFocus(); } 
            if(k===405||k===89) if(App.scr===2) { App.zone=1; App.updateFocus(); } 
            if(k===406||k===66||k===275) { e.preventDefault(); App.setScr(1); } 
        });
        
        // Gerenciamento de mem√≥ria para TV Philco
        window.addEventListener('beforeunload', function() {
            PlayerEngine.destroy();
        });
        
        // Detectar idle para otimizar performance
        var idleTimer;
        function resetIdleTimer() {
            clearTimeout(idleTimer);
            idleTimer = setTimeout(function() {
                if(App.scr === 2 && App.zone === 3 && !document.getElementById('vid-box').classList.contains('fs')) {
                    // Reduzir qualidade quando inativo
                    if(PlayerEngine.hls && PlayerEngine.hls.levels && PlayerEngine.hls.levels.length > 1) {
                        PlayerEngine.hls.currentLevel = 0;
                    }
                }
            }, 30000); // 30 segundos
        }
        
        document.addEventListener('mousemove', resetIdleTimer);
        document.addEventListener('keydown', resetIdleTimer);
        document.addEventListener('click', resetIdleTimer);
        resetIdleTimer();
    </script>
</body>
</html>
